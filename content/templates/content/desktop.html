<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux Horizon</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        .desktop {
            position: fixed;
            width: 500%;
            height: 500%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="rgba(100,100,150,0.2)"/><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            background-attachment: scroll;
            user-select: none;
            overflow: hidden;
            cursor: grab;
            will-change: transform;
            top: 0;
            left: 0;
            transform: translate(0px, 0px) scale(1);
            transform-origin: 0 0;
            transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .desktop.dragging {
            cursor: grabbing;
            transition: none;
        }

        .taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            min-height: 60px;
            background: rgba(0, 0, 0, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: flex-start;
            padding: 8px 20px;
            gap: 10px;
            z-index: 1000;
            flex-wrap: wrap;
        }

        .taskbar-item {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            max-width: 150px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .taskbar-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .taskbar-item.active {
            background: rgba(102, 126, 234, 0.8);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .button-group {
            margin-left: auto;
            display: flex;
            gap: 10px;
            align-self: flex-start;
        }

        .btn {
            padding: 8px 16px;
            background: #764ba2;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5a3680;
        }

        .desktop-icon {
            position: absolute;
            width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            cursor: grab;
            padding: 10px;
            border-radius: 4px;
            transition: background 0.15s ease, opacity 0.15s ease, box-shadow 0.15s ease;
            will-change: left, top;
        }

        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .desktop-icon.dragging {
            opacity: 0.7;
            cursor: grabbing;
            transition: none !important;
        }

        .desktop-icon.selected {
            background: rgba(102, 126, 234, 0.3);
            border: 2px solid rgba(102, 126, 234, 0.8);
        }

        .icon-image {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .icon-label {
            font-size: 11px;
            text-align: center;
            width: 100%;
            word-wrap: break-word;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .window {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 300px;
            min-height: 200px;
        }

        .window.minimized {
            display: none;
        }

        .window-header {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8));
            color: white;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
            user-select: none;
        }

        .window-title {
            font-weight: 500;
        }

        .window-controls {
            display: flex;
            gap: 8px;
        }

        .window-btn {
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .window-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .window-content {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .context-menu {
            position: fixed;
            background: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            min-width: 180px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .context-menu.hidden {
            display: none;
        }

        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .dialog.active {
            display: flex;
        }

        .dialog-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .dialog-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.8);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Responzivn√≠ design */
        @media (max-width: 768px) {
            .desktop-icon {
                width: 60px;
            }

            .icon-image {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }

            .icon-label {
                font-size: 10px;
            }

            .window {
                min-width: 200px;
                min-height: 150px;
            }

            .taskbar {
                height: 50px;
                padding: 0 10px;
            }

            .window-header {
                padding: 8px;
            }
        }

        @media (max-width: 480px) {
            .desktop-icon {
                width: 50px;
            }

            .icon-image {
                width: 35px;
                height: 35px;
                font-size: 18px;
            }

            .window {
                min-width: 90vw;
                min-height: 60vh;
            }

            .taskbar {
                height: 45px;
            }
        }

        .no-files-message {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            padding: 40px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    {% csrf_token %}
    <div class="desktop" id="desktop">
        <!-- Desktop ikony budou vygenerov√°ny JavaScriptem -->
    </div>

    <div class="taskbar" id="taskbar">
        <div id="taskbar-windows" style="display: flex; gap: 8px; flex: 1; flex-wrap: wrap; align-content: flex-start;">
            <!-- Otev≈ôen√° okna se budou p≈ôid√°vat sem -->
        </div>
        <div class="button-group">
            <button class="btn" onclick="openMailingWindow()">‚úâÔ∏è Flux</button>
            <button class="btn" onclick="openReceivedMessagesWindow()" style="position: relative;">üì¨ Doruƒçen√© Fluxy <span id="unreadBadge" style="position: absolute; top: 5px; right: 5px; background: #e74c3c; color: white; border-radius: 50%; width: 20px; height: 20px; display: none; font-size: 12px; align-items: center; justify-content: center;"></span></button>
            <button class="btn" onclick="createNewFile()">üìù Notepad</button>
            <button class="btn" onclick="createNewFolder()">+ Nov√° slo≈æka</button>
            <button class="btn" onclick="logout()">Odhl√°sit se</button>
        </div>
    </div>

    <!-- Kontextov√© menu -->
    <div class="context-menu hidden" id="contextMenu">
        <div class="context-menu-item" onclick="event.stopPropagation(); renameItem(); hideContextMenu();">P≈ôejmenovat</div>
        <div class="context-menu-item" id="extractFromFolderOption" onclick="event.stopPropagation(); extractFromFolder(); hideContextMenu();" style="display:none;">Vyndat ze slo≈æky</div>
        <div class="context-menu-item" onclick="event.stopPropagation(); deleteItem(); hideContextMenu();">Smazat</div>
        <div class="context-menu-item" onclick="event.stopPropagation(); propertiesItem(); hideContextMenu();">Vlastnosti</div>
    </div>

    <!-- Dialogy -->
    <div class="dialog" id="renameDialog">
        <div class="dialog-content">
            <div class="dialog-title">P≈ôejmenovat</div>
            <form onsubmit="confirmRename(event)">
                <div class="form-group">
                    <label for="renameInput" class="form-label">Nov√Ω n√°zev:</label>
                    <input type="text" id="renameInput" class="form-input" autofocus>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn" onclick="closeDialog('renameDialog')">Zru≈°it</button>
                    <button type="submit" class="btn">OK</button>
                </div>
            </form>
        </div>
    </div>

    <div class="dialog" id="newFileDialog">
        <div class="dialog-content">
            <div class="dialog-title">üìù Notepad - Nov√Ω soubor</div>
            <form onsubmit="confirmNewFile(event)">
                <div class="form-group">
                    <label for="newFileInput" class="form-label">N√°zev souboru:</label>
                    <input type="text" id="newFileInput" class="form-input" autofocus>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn" onclick="closeDialog('newFileDialog')">Zru≈°it</button>
                    <button type="submit" class="btn">Vytvo≈ôit</button>
                </div>
            </form>
        </div>
    </div>

    <div class="dialog" id="newFolderDialog">
        <div class="dialog-content">
            <div class="dialog-title">Nov√° slo≈æka</div>
            <form onsubmit="confirmNewFolder(event)">
                <div class="form-group">
                    <label for="newFolderInput" class="form-label">N√°zev slo≈æky:</label>
                    <input type="text" id="newFolderInput" class="form-input" autofocus>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn" onclick="closeDialog('newFolderDialog')">Zru≈°it</button>
                    <button type="submit" class="btn">Vytvo≈ôit</button>
                </div>
            </form>
        </div>
    </div>

    <div class="dialog" id="folderNameDialog">
        <div class="dialog-content">
            <div class="dialog-title">Pojmenuj novou slo≈æku</div>
            <form onsubmit="confirmNewFolderName(event)">
                <div class="form-group">
                    <label for="folderNameInput" class="form-label">N√°zev slo≈æky:</label>
                    <input type="text" id="folderNameInput" class="form-input" autofocus>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn" onclick="closeDialog('folderNameDialog')">Zru≈°it</button>
                    <button type="submit" class="btn">OK</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Confirmation Dialog -->
    <div class="dialog" id="confirmDialog">
        <div class="dialog-content">
            <div class="dialog-title" id="confirmTitle">Potvrzen√≠</div>
            <p id="confirmMessage" style="margin-bottom: 20px; color: #666;"></p>
            <div class="form-buttons">
                <button type="button" class="btn" onclick="cancelConfirm()" style="background: #999;">Zru≈°it</button>
                <button type="button" class="btn" onclick="confirmAction()" style="background: #764ba2;">OK</button>
            </div>
        </div>
    </div>

    <!-- Send Mail Confirmation Dialog -->
    <div class="dialog" id="sendMailConfirmDialog">
        <div class="dialog-content">
            <div class="dialog-title">Odeslat zpr√°vu?</div>
            <p id="sendMailConfirmMessage" style="margin-bottom: 20px; color: #666;"></p>
            <div class="form-buttons">
                <button type="button" class="btn" onclick="closeSendMailConfirm()" style="background: #999;">Zru≈°it</button>
                <button type="button" class="btn" onclick="proceedSendMail()" style="background: #764ba2;">Odeslat</button>
            </div>
        </div>
    </div>

    <!-- Mailing Window Dialog -->
    <div class="dialog" id="mailingDialog">
        <div class="dialog-content" style="max-width: 600px;">
            <div class="dialog-title">‚úâÔ∏è Flux Mail</div>
            <form onsubmit="sendMail(event)">
                <div class="form-group">
                    <label for="mailRecipients" class="form-label">P≈ô√≠jemci (u≈æivatelsk√° jm√©na, oddƒõlen√° ƒç√°rkou):</label>
                    <input type="text" id="mailRecipients" class="form-input" placeholder="u≈æivatel1, u≈æivatel2" required>
                </div>
                <div class="form-group">
                    <label for="mailSubject" class="form-label">P≈ôedmƒõt:</label>
                    <input type="text" id="mailSubject" class="form-input" placeholder="Zadejte p≈ôedmƒõt" required>
                </div>
                <div class="form-group">
                    <label for="mailBody" class="form-label">Zpr√°va:</label>
                    <textarea id="mailBody" class="form-input" style="resize: vertical; min-height: 200px; font-family: monospace;" placeholder="Zadejte zpr√°vu..." required></textarea>
                </div>
                <div class="form-group">
                    <label for="mailAttachmentArea" class="form-label">P≈ô√≠lohy:</label>
                    <button type="button" class="btn" onclick="openAttachmentSelector()" style="background: #667eea; margin-bottom: 10px;">+ Vybrat p≈ô√≠lohu</button>
                    <div id="mailAttachmentList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn" onclick="closeDialog('mailingDialog')" style="background: #999;">Zru≈°it</button>
                    <button type="submit" class="btn" style="background: #764ba2;">Poslat</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Received Messages Window -->
    <div class="dialog" id="receivedMessagesDialog">
        <div class="dialog-content" style="max-width: 800px; max-height: 600px; display: flex; flex-direction: column;">
            <div class="dialog-title" style="margin-bottom: 15px;">üì¨ Doruƒçen√© Fluxy</div>
            <div id="messagesList" style="flex: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px;">
                <p style="text-align: center; color: #999;">Naƒç√≠t√°n√≠ zpr√°v...</p>
            </div>
            <div class="form-buttons" style="margin-top: 15px;">
                <button type="button" class="btn" onclick="closeDialog('receivedMessagesDialog')" style="background: #999;">Zav≈ô√≠t</button>
            </div>
        </div>
    </div>

    <!-- Attachment Selector Dialog -->
    <div class="dialog" id="attachmentSelectorDialog">
        <div class="dialog-content" style="max-width: 600px; max-height: 700px; display: flex; flex-direction: column;">
            <div class="dialog-title">Vybrat p≈ô√≠lohy</div>
            <div style="flex: 1; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 15px; margin-bottom: 15px;">
                <div id="attachmentSelectorContent">
                    <p style="text-align: center; color: #999;">Naƒç√≠t√°n√≠...</p>
                </div>
            </div>
            <div class="form-buttons">
                <button type="button" class="btn" onclick="closeDialog('attachmentSelectorDialog')" style="background: #999;">Zru≈°it</button>
                <button type="button" class="btn" onclick="confirmAttachmentSelection()" style="background: #764ba2;">OK</button>
            </div>
        </div>
    </div>

    <script>
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        let files = [];
        let folders = [];
        let windows = {};
        let draggedItem = null;
        let currentlyDraggedForMail = null;  // Sleduje p≈ôetahovan√Ω prvek pro mail
        let selectedItem = null;
        let windowOffset = { x: 0, y: 0 };
        const WINDOW_OFFSET = 30; // Pixely pro odsazen√≠ nov√Ωch oken
        let offsetX = 0;
        let offsetY = 0;

        // Custom confirmation dialog state
        let confirmCallback = null;

        function showConfirm(title, message, onConfirm) {
            confirmCallback = onConfirm;
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmDialog').classList.add('active');
        }

        function confirmAction() {
            document.getElementById('confirmDialog').classList.remove('active');
            if (confirmCallback) {
                confirmCallback(true);
                confirmCallback = null;
            }
        }

        function cancelConfirm() {
            document.getElementById('confirmDialog').classList.remove('active');
            if (confirmCallback) {
                confirmCallback(false);
                confirmCallback = null;
            }
        }

        // Variables for send mail confirmation
        let pendingMailData = null;

        function showSendMailConfirm(recipientCount, attachmentCount) {
            // Minimize the mailing dialog
            document.getElementById('mailingDialog').classList.remove('active');
            
            let message = `Opravdu chce≈° odeslat zpr√°vu?\n\nP≈ô√≠jemci: ${recipientCount}\nP≈ô√≠lohy: ${attachmentCount}`;
            document.getElementById('sendMailConfirmMessage').textContent = message;
            document.getElementById('sendMailConfirmDialog').classList.add('active');
        }

        function closeSendMailConfirm() {
            // Restore the mailing dialog
            document.getElementById('sendMailConfirmDialog').classList.remove('active');
            document.getElementById('mailingDialog').classList.add('active');
            pendingMailData = null;
        }

        async function proceedSendMail() {
            if (!pendingMailData) return;
            
            const { recipients, subject, body, attachmentData } = pendingMailData;
            
            try {
                const response = await fetch('/api/api/messages/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        recipients: recipients,
                        subject: subject,
                        body: body,
                        attachments: attachmentData
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    showMessageDialog('Chyba', 'Chyba p≈ôi odes√≠l√°n√≠: ' + JSON.stringify(error));
                    closeSendMailConfirm();
                    return;
                }
                
                // Close both dialogs and show success message
                document.getElementById('sendMailConfirmDialog').classList.remove('active');
                closeDialog('mailingDialog');
                mailAttachments = [];
                pendingMailData = null;
                
                showMessageDialog('√öspƒõch', 'Zpr√°va √∫spƒõ≈°nƒõ odesl√°na!');
                updateUnreadBadge();
                
            } catch (error) {
                console.error('Chyba:', error);
                showMessageDialog('Chyba', 'Chyba p≈ôi odes√≠l√°n√≠: ' + error.message);
                closeSendMailConfirm();
            }
        }

        function showMessageDialog(title, message) {
            showConfirm(title, message, () => {});
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDesktopItems();
            setupEventListeners();
        });

        function setupEventListeners() {
            const desktop = document.getElementById('desktop');
            
            desktop.addEventListener('contextmenu', (e) => {
                if (e.target === desktop) {
                    e.preventDefault();
                    showContextMenu(e.clientX, e.clientY, null);
                }
            });

            desktop.addEventListener('click', (e) => {
                if (e.target === desktop) {
                    hideContextMenu();
                    selectedItem = null;
                    document.querySelectorAll('.desktop-icon').forEach(el => el.classList.remove('selected'));
                }
            });

            document.addEventListener('click', (e) => {
                const menu = document.getElementById('contextMenu');
                const isClickOnMenu = menu.contains(e.target);
                const isMenuVisible = !menu.classList.contains('hidden');
                
                if (isMenuVisible && !isClickOnMenu) {
                    hideContextMenu();
                }
            });

            // Drag and drop event listeners
            desktop.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                desktop.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
            });

            desktop.addEventListener('dragleave', (e) => {
                if (e.target === desktop) {
                    desktop.style.backgroundColor = '';
                }
            });

            desktop.addEventListener('drop', (e) => {
                e.preventDefault();
                desktop.style.backgroundColor = '';
                
                console.log('Desktop DROP event triggered');
                console.log('currentlyDraggedForMail:', currentlyDraggedForMail);
                
                // V√Ωpoƒçet pozice na desktopu (bez zoom/offset)
                const x = (e.clientX - desktopOffsetX) / desktopZoom;
                const y = (e.clientY - desktopOffsetY) / desktopZoom;
                
                // Handle dragged attachment from message
                if (currentlyDraggedForMail) {
                    console.log('Processing attachment drop:', currentlyDraggedForMail, 'at', x, y);
                    
                    if (currentMessageId) {
                        // Volat API endpoint pro kop√≠rov√°n√≠ attachmentu
                        copyAttachmentToDesktop(currentMessageId, currentlyDraggedForMail, x, y);
                    } else {
                        console.log('Chyba: currentMessageId nen√≠ nastaven');
                    }
                    
                    currentlyDraggedForMail = null;
                }
                
                // Handle files from File Explorer
                if (e.dataTransfer.files.length > 0) {
                    const files = Array.from(e.dataTransfer.files);
                    files.forEach(file => {
                        uploadFileFromDrop(file, null, x, y);
                    });
                }
            });
        }

        async function loadDesktopItems() {
            try {
                // Naƒçte soubory
                const filesResponse = await fetch('/api/api/files/desktop_files/', {
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                });
                files = await filesResponse.json();

                // Naƒçte slo≈æky na desktopu
                const foldersResponse = await fetch('/api/api/folders/root_folders/', {
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                });
                folders = await foldersResponse.json();

                renderDesktop();
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ soubor≈Ø:', error);
            }
        }

        function renderDesktop() {
            const desktop = document.getElementById('desktop');
            desktop.innerHTML = '';

            if (files.length === 0 && folders.length === 0) {
                desktop.innerHTML = '<div class="no-files-message">V√°≈° desktop je pr√°zdn√Ω. Zaƒçnƒõte vytv√°≈ôen√≠m nov√©ho souboru nebo slo≈æky.</div>';
                return;
            }

            // Renderuj slo≈æky
            folders.forEach(folder => {
                const icon = createFolderElement(folder);
                desktop.appendChild(icon);
            });

            // Renderuj soubory
            files.forEach(file => {
                const icon = createIconElement(file);
                desktop.appendChild(icon);
            });
        }

        function createFolderElement(folder) {
            const div = document.createElement('div');
            div.className = 'desktop-icon';
            div.style.left = folder.x_position + 'px';
            div.style.top = folder.y_position + 'px';
            div.dataset.folderId = folder.id;

            const icon = document.createElement('div');
            icon.className = 'icon-image';
            icon.style.background = 'linear-gradient(135deg, #FFA726 0%, #FB8C00 100%)';
            icon.textContent = 'üìÅ';

            const label = document.createElement('div');
            label.className = 'icon-label';
            label.textContent = folder.name;

            div.appendChild(icon);
            div.appendChild(label);

            // Drag and drop
            div.addEventListener('mousedown', (e) => startFolderDrag(e, folder, div));
            div.addEventListener('dblclick', () => openFolder(folder));
            div.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                selectFolder(folder, div);
                showContextMenu(e.clientX, e.clientY, folder, 'folder');
            });
            div.addEventListener('click', () => selectFolder(folder, div));

            return div;
        }

        function startFolderDrag(e, folder, element) {
            if (e.button !== 0) return;

            draggedItem = { folder, element, type: 'folder' };
            const rect = element.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;

            element.classList.add('dragging');

            function onMouseMove(e) {
                // P≈ôiƒçti desktop offset a zoom aby se ikona pohybovala spr√°vnƒõ
                const x = (e.clientX - offsetX - desktopOffsetX) / desktopZoom;
                const y = (e.clientY - offsetY - desktopOffsetY) / desktopZoom;
                element.style.left = x + 'px';
                element.style.top = y + 'px';
            }

            function onMouseUp() {
                element.classList.remove('dragging');
                const newX = parseInt(element.style.left);
                const newY = parseInt(element.style.top);
                
                // Detekovat kolizi s jin√Ωmi slo≈ækami/soubory
                const targetItem = detectCollision(element, newX, newY);
                
                if (targetItem) {
                    handleFolderCollision(folder, targetItem);
                } else {
                    updateFolderPosition(folder.id, newX, newY);
                }

                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                draggedItem = null;
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        async function handleFolderCollision(draggedFolder, targetElement) {
            const targetFileId = targetElement.dataset.fileId;
            const targetFolderId = targetElement.dataset.folderId;

            if (targetFolderId) {
                // Dvƒõ slo≈æky se st≈ôetly - p≈ôesunout dra≈æenou slo≈æku do c√≠lov√©
                const targetFolder = folders.find(f => f.id == targetFolderId);
                if (targetFolder && targetFolder.id !== draggedFolder.id) {
                    await moveFolderToFolder(draggedFolder.id, targetFolder.id);
                }
            } else if (targetFileId) {
                // Slo≈æka se p≈ôesunula na soubor - p≈ôesunout soubor do slo≈æky
                await moveFileToFolder(targetFileId, draggedFolder.id);
            }
        }

        async function createFolderFromFolders(folder1, folder2) {
            try {
                // Vytvo≈ôit novou slo≈æku
                const response = await fetch('/api/api/folders/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        name: `Slo≈æka_${new Date().getTime()}`,
                        x_position: folder1.x_position,
                        y_position: folder1.y_position
                    })
                });
                
                if (response.ok) {
                    loadDesktopItems();
                }
            } catch (error) {
                console.error('Chyba p≈ôi vytv√°≈ôen√≠ slo≈æky:', error);
            }
        }

        async function updateFolderPosition(folderId, x, y) {
            try {
                await fetch(`/api/api/folders/${folderId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ x_position: x, y_position: y })
                });
                
                // Aktualizuj lok√°ln√≠ array bez reload
                const folder = folders.find(f => f.id === folderId);
                if (folder) {
                    folder.x_position = x;
                    folder.y_position = y;
                }
            } catch (error) {
                console.error('Chyba p≈ôi aktualizaci pozice slo≈æky:', error);
            }
        }

        async function updateFolderParent(folderId, parentFolderId, x, y) {
            try {
                const body = { x_position: x, y_position: y };
                if (parentFolderId !== null) {
                    body.parent_folder = parentFolderId;
                }
                
                await fetch(`/api/api/folders/${folderId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(body)
                });
                
                // Aktualizuj lok√°ln√≠ array bez reload
                const folder = folders.find(f => f.id === folderId);
                if (folder) {
                    folder.x_position = x;
                    folder.y_position = y;
                    if (parentFolderId !== null) {
                        folder.parent_folder = parentFolderId;
                    }
                }
            } catch (error) {
                console.error('Chyba p≈ôi p≈ôesunov√°n√≠ slo≈æky:', error);
            }
        }

        function selectFolder(folder, element) {
            document.querySelectorAll('.desktop-icon').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedItem = { ...folder, type: 'folder' };
        }

        function openFolder(folder) {
            // Otev≈ôe slo≈æku v nov√©m oknƒõ
            const windowId = 'window-folder-' + folder.id;
            const existingWindow = document.getElementById(windowId);
            
            if (existingWindow) {
                // Okno ji≈æ existuje, p≈ôesunout do pop≈ôed√≠ a odminimalizovat
                const maxZIndex = Math.max(...Object.values(windows).map((w, i) => {
                    const el = document.getElementById(Object.keys(windows)[i]);
                    return el ? parseInt(window.getComputedStyle(el).zIndex) || 500 : 500;
                }));
                
                existingWindow.style.zIndex = maxZIndex + 1;
                
                // Pokud je minimalizovan√©, zobrazit
                if (existingWindow.classList.contains('minimized')) {
                    existingWindow.classList.remove('minimized');
                    const taskbarItem = document.getElementById('taskbar-' + windowId);
                    if (taskbarItem) {
                        taskbarItem.classList.remove('active');
                    }
                }
            } else {
                // Okno neexistuje, vytvo≈ôit nov√©
                createFolderWindow(folder);
            }
        }

        function getColorForFileType(fileType) {
            const colors = {
                'text': '#4CAF50',      // Zelen√°
                'image': '#4A90E2',     // Modr√°
                'document': '#E27D5D',  // ƒåerveno-oran≈æov√°
                'video': '#9B59B6',     // Fialov√°
                'audio': '#F5F5F5',     // B√≠l√°
                'archive': '#F5A623',   // Oran≈æov√°
                'folder': '#4A90E2'     // Modr√°
            };
            return colors[fileType] || '#4A90E2';
        }

        function createIconElement(file) {
            const div = document.createElement('div');
            div.className = 'desktop-icon';
            div.style.left = file.x_position + 'px';
            div.style.top = file.y_position + 'px';
            div.dataset.fileId = file.id;

            const iconTypes = {
                'text': 'üìÑ',
                'image': 'üñºÔ∏è',
                'document': 'üìã',
                'video': 'üé¨',
                'audio': 'üéµ',
                'archive': 'üì¶',
                'other': 'üìÅ'
            };

            const icon = document.createElement('div');
            icon.className = 'icon-image';
            icon.style.background = file.icon_color;
            icon.textContent = iconTypes[file.file_type] || 'üìÅ';

            const label = document.createElement('div');
            label.className = 'icon-label';
            label.textContent = file.name;

            div.appendChild(icon);
            div.appendChild(label);

            // Drag and drop
            div.addEventListener('mousedown', (e) => startDrag(e, file, div));
            div.addEventListener('dblclick', () => openFile(file));
            div.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                selectItem(file, div);
                showContextMenu(e.clientX, e.clientY, file);
            });
            div.addEventListener('click', () => selectItem(file, div));

            return div;
        }

        function startDrag(e, file, element) {
            if (e.button !== 0) return;

            draggedItem = { file, element, type: 'file' };
            // Sleduj pro mail drop
            currentlyDraggedForMail = { 
                id: file.id, 
                type: 'file', 
                name: file.name,
                file_type: file.file_type
            };
            
            const rect = element.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;

            element.classList.add('dragging');

            function onMouseMove(e) {
                // P≈ôiƒçti desktop offset a zoom aby se ikona pohybovala spr√°vnƒõ
                const x = (e.clientX - offsetX - desktopOffsetX) / desktopZoom;
                const y = (e.clientY - offsetY - desktopOffsetY) / desktopZoom;
                element.style.left = x + 'px';
                element.style.top = y + 'px';
            }

            function onMouseUp() {
                element.classList.remove('dragging');
                const newX = parseInt(element.style.left);
                const newY = parseInt(element.style.top);
                
                // Detekovat kolizi s jin√Ωmi polo≈ækami
                const targetItem = detectCollision(element, newX, newY);
                
                if (targetItem) {
                    handleItemCollision(file, targetItem);
                } else {
                    updateFilePosition(file.id, newX, newY);
                }

                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                draggedItem = null;
                currentlyDraggedForMail = null;
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        function startAttachmentDrag(e) {
            // HTML5 Drag and Drop
            console.log('Attachment drag started');
            
            const element = e.target.closest('.attachment-item-msg');
            if (!element) return;
            
            // Nastavit data co se p≈ôetahuje pro drag-and-drop
            currentlyDraggedForMail = {
                id: parseInt(element.dataset.itemId),
                type: element.dataset.itemType,
                name: element.dataset.itemName
            };
            
            console.log('Set currentlyDraggedForMail:', currentlyDraggedForMail);
            
            element.style.cursor = 'grabbing';
            element.style.opacity = '0.7';
            
            // setData for native drag-and-drop
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify(currentlyDraggedForMail));
        }

        function endAttachmentDrag(e) {
            console.log('Attachment drag ended');
            const element = e.target.closest('.attachment-item-msg');
            if (element) {
                element.style.cursor = 'grab';
                element.style.opacity = '1';
            }
            // Note: don't clear currentlyDraggedForMail here - let drop handler do it
        }

        async function copyAttachmentToDesktop(messageId, attachment, x, y) {
            try {
                console.log('Copying attachment:', attachment);
                console.log('Attachment.id type:', typeof attachment.id, 'value:', attachment.id);
                console.log('Attachment.type:', attachment.type);
                
                const response = await fetch(`/api/api/messages/${messageId}/copy_attachment/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        attachment_id: attachment.id,
                        type: attachment.type,
                        x_position: x,
                        y_position: y
                    })
                });
                
                console.log('Copy attachment response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Attachment copied successfully:', data);
                    
                    // P≈ôidat nov√Ω soubor/slo≈æku do glob√°ln√≠ho pole
                    if (attachment.type === 'file' && data.file) {
                        files.push(data.file);
                    } else if (attachment.type === 'folder' && data.folder) {
                        folders.push(data.folder);
                    }
                    
                    // P≈ôekreslit desktop
                    renderDesktop();
                } else {
                    const error = await response.json();
                    console.error('Chyba p≈ôi kop√≠rov√°n√≠ attachmentu:', error);
                    alert('Chyba p≈ôi kop√≠rov√°n√≠ attachmentu: ' + error.error);
                }
            } catch (error) {
                console.error('Chyba:', error);
                alert('Chyba p≈ôi kop√≠rov√°n√≠ attachmentu');
            }
        }

        function detectCollision(draggedElement, x, y) {
            const draggedRect = {
                left: x,
                top: y,
                right: x + draggedElement.offsetWidth,
                bottom: y + draggedElement.offsetHeight
            };

            const icons = document.querySelectorAll('.desktop-icon');
            for (let icon of icons) {
                if (icon === draggedElement) continue;
                
                const iconRect = {
                    left: parseInt(icon.style.left),
                    top: parseInt(icon.style.top),
                    right: parseInt(icon.style.left) + icon.offsetWidth,
                    bottom: parseInt(icon.style.top) + icon.offsetHeight
                };

                // Kontrola, zda se obd√©ln√≠ky p≈ôekr√Ωvaj√≠
                if (draggedRect.left < iconRect.right &&
                    draggedRect.right > iconRect.left &&
                    draggedRect.top < iconRect.bottom &&
                    draggedRect.bottom > iconRect.top) {
                    return icon;
                }
            }
            return null;
        }

        function startFolderItemDrag(e, element, folderId) {
            if (e.button !== 0) return;
            
            const itemId = parseInt(element.dataset.itemId);
            const itemType = element.dataset.itemType;
            
            // Prvo, ƒçeka se delay od 100ms prije nego ≈°to se poƒçne drag
            let dragStarted = false;
            let dragTimeout = setTimeout(() => {
                dragStarted = true;
            }, 100);
            
            const rect = element.getBoundingClientRect();
            const offsetX = e.clientX - rect.left;
            const offsetY = e.clientY - rect.top;
            
            // Kreiraj privremeni drag element
            const dragElement = element.cloneNode(true);
            dragElement.style.position = 'fixed';
            dragElement.style.pointerEvents = 'none';
            dragElement.style.opacity = '0.7';
            dragElement.style.zIndex = '10000';
            dragElement.style.width = rect.width + 'px';
            dragElement.style.height = rect.height + 'px';
            document.body.appendChild(dragElement);
            
            function onMouseMove(moveEvent) {
                if (!dragStarted) return;
                
                dragElement.style.left = (moveEvent.clientX - offsetX) + 'px';
                dragElement.style.top = (moveEvent.clientY - offsetY) + 'px';
            }
            
            function onMouseUp(upEvent) {
                clearTimeout(dragTimeout);
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                dragElement.remove();
                
                if (!dragStarted) return;
                
                // Provjeri je li korisnik pustio element van prozora
                const windowId = `window-folder-${folderId}`;
                const folderWindow = document.getElementById(windowId);
                
                if (folderWindow) {
                    const windowRect = folderWindow.getBoundingClientRect();
                    const dropX = upEvent.clientX;
                    const dropY = upEvent.clientY;
                    
                    // Provjeravamo je li drop ostao u istom prozoru
                    const isInsideWindow = dropX >= windowRect.left && 
                                         dropX <= windowRect.right &&
                                         dropY >= windowRect.top && 
                                         dropY <= windowRect.bottom;
                    
                    if (!isInsideWindow) {
                        // Korisnik je prevukao element van prozora - premjesti ga na desktop
                        const desktopX = dropX;
                        const desktopY = dropY;
                        
                        if (itemType === 'file') {
                            moveFileOutOfFolder(itemId, folderId, desktopX, desktopY);
                        } else if (itemType === 'folder') {
                            moveFolderOutOfFolder(itemId, folderId, desktopX, desktopY);
                        }
                    }
                }
            }
            
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        }

        async function moveFileOutOfFolder(fileId, folderId, x, y) {
            try {
                await fetch(`/api/api/files/${fileId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ 
                        folder: null,
                        x_position: x,
                        y_position: y
                    })
                });
                // Osvje≈æi sadr≈æaj mape i desktop
                loadFolderContent(folderId);
                loadDesktopItems();
            } catch (error) {
                console.error('Gre≈°ka pri premje≈°tanju datoteke van mape:', error);
            }
        }

        async function moveFolderOutOfFolder(folderId, parentFolderId, x, y) {
            try {
                await fetch(`/api/api/folders/${folderId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ 
                        parent: null,
                        x_position: x,
                        y_position: y
                    })
                });
                // Osvje≈æi sadr≈æaj mape i desktop
                loadFolderContent(parentFolderId);
                loadDesktopItems();
            } catch (error) {
                console.error('Gre≈°ka pri premje≈°tanju mape van mape:', error);
            }
        }

        async function handleItemCollision(draggedFile, targetElement) {
            const targetFileId = targetElement.dataset.fileId;
            const targetFolderId = targetElement.dataset.folderId;

            if (targetFolderId) {
                // Soubor se p≈ôesunuje na slo≈æku - vlo≈æit do slo≈æky
                await moveFileToFolder(draggedFile.id, targetFolderId);
            } else if (targetFileId) {
                // Dva soubory se st≈ôetly - vytvo≈ôit novou slo≈æku
                const targetFile = files.find(f => f.id == targetFileId);
                if (targetFile) {
                    await createFolderFromFiles(draggedFile, targetFile);
                }
            }
        }

        async function moveFileToFolder(fileId, folderId) {
            try {
                await fetch(`/api/api/files/${fileId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ folder: folderId })
                });
                // Znovu naƒç√≠st desktop
                loadDesktopItems();
            } catch (error) {
                console.error('Chyba p≈ôi p≈ôesunu do slo≈æky:', error);
            }
        }

        async function moveFolderToFolder(folderId, parentFolderId) {
            try {
                await fetch(`/api/api/folders/${folderId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({ parent: parentFolderId })
                });
                loadDesktopItems();
            } catch (error) {
                console.error('Chyba p≈ôi p≈ôesunu slo≈æky:', error);
            }
        }

        async function createFolderFromFiles(file1, file2) {
            // Ulo≈æit data pro pozdƒõj≈°√≠ vytvo≈ôen√≠ slo≈æky
            window.pendingFiles = [file1.id, file2.id];
            window.pendingFolderPosition = {
                x_position: file1.x_position,
                y_position: file1.y_position
            };
            
            // Otev≈ô√≠t dialog pro pojmenov√°n√≠
            document.getElementById('folderNameInput').value = '';
            document.getElementById('folderNameDialog').classList.add('active');
        }

        async function confirmNewFolderName(event) {
            event.preventDefault();
            let folderName = document.getElementById('folderNameInput').value.trim();
            
            if (!folderName) {
                alert('Pros√≠m, zadejte n√°zev slo≈æky');
                return;
            }

            // Ovƒõ≈ôit duplicitn√≠ jm√©no a z√≠skat unik√°tn√≠ jm√©no
            if (checkDuplicateFolderName(folderName)) {
                folderName = getUniqueFolderName(folderName);
            }

            closeDialog('folderNameDialog');

            try {
                // Vytvo≈ôit novou slo≈æku s u≈æivatelem zadan√Ωm n√°zvem
                const response = await fetch('/api/api/folders/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        name: folderName,
                        x_position: window.pendingFolderPosition.x_position,
                        y_position: window.pendingFolderPosition.y_position
                    })
                });
                
                if (response.ok) {
                    const newFolder = await response.json();
                    
                    // P≈ôesunout oba soubory do nov√© slo≈æky
                    for (let fileId of window.pendingFiles) {
                        await moveFileToFolder(fileId, newFolder.id);
                    }
                    
                    loadDesktopItems();
                }
            } catch (error) {
                console.error('Chyba p≈ôi vytv√°≈ôen√≠ slo≈æky:', error);
            }
        }

        async function updateFilePosition(fileId, x, y, folderId = null) {
            try {
                const body = { x_position: x, y_position: y };
                if (folderId !== null) {
                    body.folder = folderId;
                }
                
                await fetch(`/api/api/files/${fileId}/update_position/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify(body)
                });
                
                // Aktualizuj lok√°ln√≠ array bez reload
                const file = files.find(f => f.id === fileId);
                if (file) {
                    file.x_position = x;
                    file.y_position = y;
                    if (folderId !== null) {
                        file.folder = folderId;
                    }
                }
            } catch (error) {
                console.error('Chyba p≈ôi aktualizaci pozice:', error);
            }
        }

        function openFile(file) {
            // Otev≈ôe soubor v nov√©m oknƒõ
            const windowId = 'window-file-' + file.id;
            const existingWindow = document.getElementById(windowId);
            
            if (!existingWindow) {
                // Okno neexistuje, vytvo≈ôit nov√©
                createWindow(file, windowId);
            } else {
                // Okno ji≈æ existuje, p≈ôesunout do pop≈ôed√≠ a odminimalizovat
                const maxZIndex = Math.max(...Object.values(windows).map((w, i) => {
                    const el = document.getElementById(Object.keys(windows)[i]);
                    return el ? parseInt(window.getComputedStyle(el).zIndex) || 500 : 500;
                }));
                
                existingWindow.style.zIndex = maxZIndex + 1;
                
                // Pokud je minimalizovan√©, zobrazit
                if (existingWindow.classList.contains('minimized')) {
                    existingWindow.classList.remove('minimized');
                    const taskbarItem = document.getElementById('taskbar-' + windowId);
                    if (taskbarItem) {
                        taskbarItem.classList.remove('active');
                    }
                }
            }
        }

        function createFolderWindow(folder) {
            const windowId = 'window-folder-' + folder.id;
            // Kontrola se nyn√≠ prov√°d√≠ v openFolder(), zde se p≈ôedpokl√°d√°, ≈æe okno neexistuje

            const window = document.createElement('div');
            window.className = 'window';
            window.id = windowId;
            window.style.left = '150px';
            window.style.top = '150px';
            window.style.width = '700px';
            window.style.height = '500px';
            window.style.zIndex = '500';

            window.innerHTML = `
                <div class="window-header">
                    <div class="window-title">üìÅ ${folder.name}</div>
                    <div class="window-controls">
                        <button class="window-btn" onclick="minimizeWindow('${windowId}')">‚àí</button>
                        <button class="window-btn" onclick="maximizeWindow('${windowId}')">‚ñ°</button>
                        <button class="window-btn" onclick="closeWindow('${windowId}')">‚úï</button>
                    </div>
                </div>
                <div class="window-content" id="folder-content-${folder.id}">
                    <p style="text-align: center; color: #999;">Naƒç√≠t√°n√≠...</p>
                </div>
            `;

            document.body.appendChild(window);
            makeWindowDraggable(window);
            makeWindowResizable(window);
            addToTaskbar(windowId);

            // Naƒçte obsah slo≈æky
            loadFolderContent(folder.id);
        }

        async function loadFolderContent(folderId) {
            try {
                const response = await fetch(`/api/api/folders/${folderId}/contents/`, {
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                });
                const data = await response.json();
                
                const contentDiv = document.getElementById(`folder-content-${folderId}`);
                if (data.folders.length === 0 && data.files.length === 0) {
                    contentDiv.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">Slo≈æka je pr√°zdn√°</p>';
                } else {
                    let html = '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 20px; padding: 10px;">';
                    
                    data.folders.forEach(folder => {
                        html += `
                            <div class="folder-item" 
                                 style="display: flex; flex-direction: column; align-items: center; padding: 10px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" 
                                 data-item-id="${folder.id}"
                                 data-item-name="${folder.name}"
                                 data-item-type="folder"
                                 data-item-parent="${folder.parent}"
                                 onmouseover="this.style.background='rgba(102,126,234,0.1)'" 
                                 onmouseout="this.style.background='transparent'"
                                 ondblclick="openFolder({id: ${folder.id}, name: '${folder.name}', x_position: ${folder.x_position}, y_position: ${folder.y_position}, parent: ${folder.parent}})">
                                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #FFA726, #FB8C00); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 30px; margin-bottom: 8px;">üìÅ</div>
                                <div style="font-size: 11px; text-align: center; word-wrap: break-word; width: 100%;">${folder.name}</div>
                            </div>
                        `;
                    });
                    
                    data.files.forEach(file => {
                        const iconTypes = {
                            'text': 'üìÑ',
                            'image': 'üñºÔ∏è',
                            'document': 'üìã',
                            'video': 'üé¨',
                            'audio': 'üéµ',
                            'archive': 'üì¶',
                            'other': 'üìÅ'
                        };
                        const safeFileName = file.name.replace(/'/g, "\\'");
                        const safeContent = (file.content || '').replace(/'/g, "\\'");
                        html += `
                            <div class="file-item"
                                 style="display: flex; flex-direction: column; align-items: center; padding: 10px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" 
                                 data-item-id="${file.id}"
                                 data-item-name="${file.name}"
                                 data-item-type="file"
                                 data-item-folder="${file.folder}"
                                 onmouseover="this.style.background='rgba(102,126,234,0.1)'" 
                                 onmouseout="this.style.background='transparent'"
                                 ondblclick="openFile({id: ${file.id}, name: '${safeFileName}', file_type: '${file.file_type}', content: '${safeContent}', icon_color: '${file.icon_color}', folder: ${file.folder}})">
                                <div style="width: 60px; height: 60px; background: ${file.icon_color}; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 30px; margin-bottom: 8px;">${iconTypes[file.file_type] || 'üìÅ'}</div>
                                <div style="font-size: 11px; text-align: center; word-wrap: break-word; width: 100%;">${file.name}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    contentDiv.innerHTML = html;
                    
                    // P≈ôidat event listenery pro context menu a drag-and-drop na dynamicky generovan√© prvky
                    contentDiv.querySelectorAll('.file-item, .folder-item').forEach(item => {
                        item.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            const itemData = {
                                id: parseInt(item.dataset.itemId),
                                name: item.dataset.itemName,
                                [item.dataset.itemType === 'file' ? 'folder' : 'parent']: item.dataset.itemType === 'file' ? parseInt(item.dataset.itemFolder) : parseInt(item.dataset.itemParent)
                            };
                            console.log('Context menu on', item.dataset.itemType, ':', itemData);
                            showContextMenu(e.clientX, e.clientY, itemData, item.dataset.itemType);
                        });
                        
                        // Drag and drop pro polo≈æky v slo≈æce
                        item.addEventListener('mousedown', (e) => startFolderItemDrag(e, item, folderId));
                    });
                }
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ obsahu slo≈æky:', error);
            }
        }

        function getNextWindowPosition() {
            // Vypoƒç√≠tat pozici pro nov√© okno s odsazen√≠m
            const taskbarHeight = 120; // Taskbar v√Ω≈°ka + padding
            const maxY = window.innerHeight - taskbarHeight - 200; // Vyhradit m√≠sto pro taskbar
            
            let x = 50 + windowOffset.x;
            let y = 50 + windowOffset.y;

            // Aktualizovat offset pro dal≈°√≠ okno
            windowOffset.x += WINDOW_OFFSET;
            windowOffset.y += WINDOW_OFFSET;

            // Reset offset pokud je okno mimo viewport
            if (x > window.innerWidth - 300 || y > maxY) {
                windowOffset.x = 0;
                windowOffset.y = 0;
                x = 50;
                y = 50;
            }

            return { x, y };
        }

        function checkDuplicateFileName(fileName, fileType, targetFolder = null) {
            // Kontrola duplicit v seznamu soubor≈Ø
            return files.some(f => 
                f.name === fileName && 
                f.file_type === fileType &&
                f.folder === targetFolder
            );
        }

        function checkDuplicateFolderName(folderName, parentFolder = null) {
            // Kontrola duplicit v seznamu slo≈æek
            return folders.some(f => 
                f.name === folderName && 
                f.parent === parentFolder
            );
        }

        function getUniqueFileName(baseName, fileType, targetFolder = null) {
            // Pokud jm√©no ji≈æ existuje, p≈ôidat ƒç√≠slo
            let fileName = baseName;
            let counter = 1;
            const extension = baseName.includes('.') ? baseName.substring(baseName.lastIndexOf('.')) : '';
            const nameWithoutExt = baseName.includes('.') ? baseName.substring(0, baseName.lastIndexOf('.')) : baseName;

            while (checkDuplicateFileName(fileName, fileType, targetFolder)) {
                fileName = `${nameWithoutExt}(${counter})${extension}`;
                counter++;
            }
            return fileName;
        }

        function getUniqueFolderName(baseName, parentFolder = null) {
            // Pokud jm√©no slo≈æky ji≈æ existuje, p≈ôidat ƒç√≠slo
            let folderName = baseName;
            let counter = 1;

            while (checkDuplicateFolderName(folderName, parentFolder)) {
                folderName = `${baseName}(${counter})`;
                counter++;
            }
            return folderName;
        }

        function createWindow(file, windowId) {
            const window = document.createElement('div');
            window.className = 'window';
            window.id = windowId;
            
            // Z√≠skat smart pozici pro okno
            const pos = getNextWindowPosition();
            window.style.left = pos.x + 'px';
            window.style.top = pos.y + 'px';
            window.style.width = '600px';
            window.style.height = '400px';
            window.style.zIndex = '500';

            // Urƒçit typ obsahu a vykreslit p≈ô√≠slu≈°n√Ω obsah
            let contentHtml = '';
            
            if (file.file_type === 'text' || file.name.endsWith('.txt')) {
                // Textov√Ω soubor
                contentHtml = `
                    <div style="display: flex; flex-direction: column; flex: 1; overflow: hidden;">
                        <textarea id="file-content-${file.id}" style="flex: 1; padding: 10px; font-family: monospace; border: none; resize: none; outline: none;">${file.content || ''}</textarea>
                        <div style="padding: 10px; background: #f5f5f5; border-top: 1px solid #ddd; display: flex; gap: 10px;">
                            <button class="btn" onclick="saveFileContent(${file.id}, '${file.name.replace(/'/g, "\\'")}')" style="flex: 1;">Ulo≈æit</button>
                            <button class="btn" onclick="resetFileContent(${file.id})" style="flex: 1;">Zru≈°it</button>
                        </div>
                    </div>
                `;
            } else if (file.file_type === 'image') {
                // Obr√°zek
                contentHtml = `
                    <div style="display: flex; flex-direction: column; flex: 1; overflow: auto; align-items: center; justify-content: center; padding: 20px;">
                        <img src="${file.content || ''}" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="${file.name}" />
                    </div>
                `;
            } else if (file.file_type === 'video') {
                // Video
                contentHtml = `
                    <div style="display: flex; flex-direction: column; flex: 1; overflow: auto; padding: 10px;">
                        <video style="width: 100%; height: 100%; object-fit: contain;" controls>
                            <source src="${file.content || ''}" />
                            V√°≈° prohl√≠≈æeƒç nepodporuje video tag.
                        </video>
                    </div>
                `;
            } else if (file.file_type === 'audio') {
                // Audio
                contentHtml = `
                    <div style="display: flex; flex-direction: column; flex: 1; overflow: auto; justify-content: center; align-items: center; padding: 20px;">
                        <audio style="width: 90%;" controls>
                            <source src="${file.content || ''}" />
                            V√°≈° prohl√≠≈æeƒç nepodporuje audio tag.
                        </audio>
                    </div>
                `;
            } else if (file.file_type === 'document') {
                // Dokument (PDF, Word, PowerPoint apod.)
                const fileName = file.name.toLowerCase();
                if (fileName.endsWith('.pdf')) {
                    // PDF - zobrazit jako embed
                    contentHtml = `
                        <div style="display: flex; flex-direction: column; flex: 1; overflow: auto;">
                            <iframe src="${file.content}" style="width: 100%; height: 100%; border: none;"></iframe>
                        </div>
                    `;
                } else if (fileName.endsWith('.docx') || fileName.endsWith('.doc') || fileName.endsWith('.pptx') || fileName.endsWith('.ppt')) {
                    // Word, PowerPoint - zobrazit zpr√°vu se tlaƒç√≠tkem sta≈æen√≠
                    contentHtml = `
                        <div style="display: flex; flex-direction: column; flex: 1; overflow: auto; padding: 20px; align-items: center; justify-content: center;">
                            <p style="font-size: 16px; color: #666;">${file.name}</p>
                            <p style="color: #999; margin-top: 10px;">Soubor ${file.name.split('.').pop().toUpperCase()} se ned√° zobrazit v prohl√≠≈æeƒçi</p>
                            <button class="btn" onclick="downloadFile(${file.id}, '${file.name.replace(/'/g, "\\'")}', '${file.content.replace(/'/g, "\\'")}')" style="margin-top: 20px;">St√°hnout soubor</button>
                        </div>
                    `;
                } else {
                    // Ostatn√≠ dokumenty (text content)
                    contentHtml = `
                        <div style="display: flex; flex-direction: column; flex: 1; overflow: auto; padding: 20px;">
                            <p style="white-space: pre-wrap; word-wrap: break-word; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">${file.content || 'Obsah dokumentu...'}</p>
                        </div>
                    `;
                }
            } else {
                // Ostatn√≠
                contentHtml = `
                    <div class="window-content">
                        <p>${file.content || 'Obsah souboru...'}</p>
                    </div>
                `;
            }

            window.innerHTML = `
                <div class="window-header">
                    <div class="window-title">${file.name}</div>
                    <div class="window-controls">
                        <button class="window-btn" onclick="minimizeWindow('${windowId}')">‚àí</button>
                        <button class="window-btn" onclick="maximizeWindow('${windowId}')">‚ñ°</button>
                        <button class="window-btn" onclick="closeWindow('${windowId}')">‚úï</button>
                    </div>
                </div>
                ${contentHtml}
            `;

            document.body.appendChild(window);

            // P≈ôidat drop event listener na okno pro drop soubor≈Ø
            window.addEventListener('dragover', (e) => {
                e.preventDefault();
                window.style.opacity = '0.7';
            });

            window.addEventListener('dragleave', (e) => {
                if (e.target === window) {
                    window.style.opacity = '1';
                }
            });

            window.addEventListener('drop', (e) => {
                e.preventDefault();
                window.style.opacity = '1';
                if (e.dataTransfer.files.length > 0) {
                    uploadFileFromDrop(e.dataTransfer.files[0], file.file_type);
                }
            });

            // Drag a resize
            makeWindowDraggable(window);
            makeWindowResizable(window);
            addToTaskbar(windowId);

            windows[windowId] = file;
        }

        function makeWindowDraggable(windowEl) {
            const header = windowEl.querySelector('.window-header');
            let x = 0, y = 0, mouseX = 0, mouseY = 0;

            header.addEventListener('mousedown', (e) => {
                mouseX = e.clientX;
                mouseY = e.clientY;
                const rect = windowEl.getBoundingClientRect();
                x = rect.left;
                y = rect.top;

                function onMouseMove(e) {
                    const deltaX = e.clientX - mouseX;
                    const deltaY = e.clientY - mouseY;
                    windowEl.style.left = (x + deltaX) + 'px';
                    windowEl.style.top = (y + deltaY) + 'px';
                }

                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }

        function makeWindowResizable(windowEl) {
            const resizeHandle = document.createElement('div');
            resizeHandle.style.cssText = 'position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; cursor: se-resize; background: linear-gradient(135deg, transparent 50%, rgba(102, 126, 234, 0.5) 50%);';
            windowEl.appendChild(resizeHandle);

            resizeHandle.addEventListener('mousedown', (e) => {
                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = windowEl.offsetWidth;
                const startHeight = windowEl.offsetHeight;

                function onMouseMove(e) {
                    windowEl.style.width = (startWidth + e.clientX - startX) + 'px';
                    windowEl.style.height = (startHeight + e.clientY - startY) + 'px';
                }

                function onMouseUp() {
                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                }

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            });
        }

        function selectItem(file, element) {
            document.querySelectorAll('.desktop-icon').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedItem = { ...file, type: 'file' };
        }

        function showContextMenu(x, y, item, itemType) {
            console.log('showContextMenu called with item:', item, 'itemType:', itemType);
            selectedItem = item ? { ...item, type: itemType || 'file' } : null;
            console.log('selectedItem nastaveno na:', selectedItem);
            const menu = document.getElementById('contextMenu');
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.classList.remove('hidden');
            
            // Uk√°zat "Vyndat ze slo≈æky" pokud je soubor ve slo≈æce nebo slo≈æka v slo≈æce
            const extractOption = document.getElementById('extractFromFolderOption');
            if (selectedItem) {
                const hasFolder = (selectedItem.type === 'file' && selectedItem.folder !== null && selectedItem.folder !== undefined);
                const hasParent = (selectedItem.type === 'folder' && selectedItem.parent !== null && selectedItem.parent !== undefined);
                
                if (hasFolder || hasParent) {
                    extractOption.style.display = 'block';
                } else {
                    extractOption.style.display = 'none';
                }
            } else {
                extractOption.style.display = 'none';
            }
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.add('hidden');
        }

        async function extractFromFolder() {
            if (!selectedItem) return;
            
            const isFileInFolder = (selectedItem.type === 'file' && selectedItem.folder !== null && selectedItem.folder !== undefined);
            const isFolderInFolder = (selectedItem.type === 'folder' && selectedItem.parent !== null && selectedItem.parent !== undefined);
            
            if (!isFileInFolder && !isFolderInFolder) return;
            
            try {
                const parentFolderId = selectedItem.type === 'file' ? selectedItem.folder : selectedItem.parent;
                
                if (selectedItem.type === 'file') {
                    // Vyndat soubor ze slo≈æky
                    await fetch(`/api/api/files/${selectedItem.id}/`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({ folder: null })
                    });
                } else if (selectedItem.type === 'folder') {
                    // Vyndat slo≈æku ze slo≈æky (nastavit parent na null)
                    await fetch(`/api/api/folders/${selectedItem.id}/`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({ parent: null })
                    });
                }
                
                // Reload desktop items
                loadDesktopItems();
                
                // Reload folder window obsah pokud existuje
                if (parentFolderId && document.getElementById(`folder-content-${parentFolderId}`)) {
                    loadFolderContent(parentFolderId);
                }
                
                hideContextMenu();
                selectedItem = null;
            } catch (error) {
                console.error('Chyba p≈ôi vynƒõt√≠ ze slo≈æky:', error);
                alert('Chyba: ' + error.message);
            }
        }

        function createNewFile() {
            document.getElementById('newFileDialog').classList.add('active');
        }

        function createNewFolder() {
            document.getElementById('newFolderDialog').classList.add('active');
        }

        function renameItem() {
            console.log('renameItem called, selectedItem:', selectedItem);
            if (selectedItem) {
                document.getElementById('renameInput').value = selectedItem.name;
                document.getElementById('renameDialog').classList.add('active');
            } else {
                console.log('selectedItem je pr√°zdn√Ω!');
            }
        }

        async function deleteItem() {
            console.log('deleteItem called, selectedItem:', selectedItem);
            if (selectedItem) {
                showConfirm('Smazat polo≈æku', 'Opravdu chcete smazat tuto polo≈æku?', async (confirmed) => {
                    if (confirmed) {
                        try {
                            const endpoint = selectedItem.type === 'folder' ? 'folders' : 'files';
                            await fetch(`/api/api/${endpoint}/${selectedItem.id}/`, {
                                method: 'DELETE',
                                headers: {
                                    'X-CSRFToken': csrftoken
                                }
                            });
                            loadDesktopItems();
                            
                            // Reload folder windows pokud je soubor/slo≈æka ve slo≈æce
                            if (selectedItem.type === 'file' && selectedItem.folder) {
                                const folderContentDiv = document.getElementById(`folder-content-${selectedItem.folder}`);
                                if (folderContentDiv) {
                                    loadFolderContent(selectedItem.folder);
                                }
                            } else if (selectedItem.type === 'folder' && selectedItem.parent) {
                                const folderContentDiv = document.getElementById(`folder-content-${selectedItem.parent}`);
                                if (folderContentDiv) {
                                    loadFolderContent(selectedItem.parent);
                                }
                            }
                            
                            selectedItem = null;
                        } catch (error) {
                            console.error('Chyba p≈ôi maz√°n√≠:', error);
                        }
                    }
                });
            } else {
                console.log('Zru≈°eno nebo selectedItem pr√°zdn√Ω');
            }
        }

        function propertiesItem() {
            if (selectedItem) {
                const created = selectedItem.created_at ? new Date(selectedItem.created_at).toLocaleString('cs-CZ') : 'Nezn√°mo';
                if (selectedItem.type === 'folder') {
                    alert(`Vlastnosti slo≈æky:\nN√°zev: ${selectedItem.name}\nVytvo≈ôeno: ${created}`);
                } else {
                    alert(`Vlastnosti souboru:\nN√°zev: ${selectedItem.name}\nTyp: ${selectedItem.file_type || 'Nezn√°m√Ω'}\nVelikost: ${selectedItem.file_size || 0} B\nVytvo≈ôeno: ${created}`);
                }
            }
        }

        async function confirmRename(e) {
            e.preventDefault();
            if (selectedItem) {
                const newName = document.getElementById('renameInput').value;
                try {
                    const endpoint = selectedItem.type === 'folder' ? 'folders' : 'files';
                    const url = selectedItem.type === 'folder' 
                        ? `/api/api/folders/${selectedItem.id}/`
                        : `/api/api/files/${selectedItem.id}/rename/`;
                    
                    const method = selectedItem.type === 'folder' ? 'PATCH' : 'POST';
                    
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({ name: newName })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        console.error('API chyba:', error);
                        alert('Chyba: ' + JSON.stringify(error));
                        return;
                    }
                    
                    loadDesktopItems();
                    
                    // Reload folder windows pokud je soubor ve slo≈æce
                    if (selectedItem.type === 'file' && selectedItem.folder) {
                        const folderContentDiv = document.getElementById(`folder-content-${selectedItem.folder}`);
                        if (folderContentDiv) {
                            loadFolderContent(selectedItem.folder);
                        }
                    } else if (selectedItem.type === 'folder' && selectedItem.parent) {
                        // Reload parent folder window
                        const folderContentDiv = document.getElementById(`folder-content-${selectedItem.parent}`);
                        if (folderContentDiv) {
                            loadFolderContent(selectedItem.parent);
                        }
                    }
                    
                    closeDialog('renameDialog');
                    selectedItem = null;
                } catch (error) {
                    console.error('Chyba p≈ôi p≈ôejmenov√°n√≠:', error);
                    alert('Chyba: ' + error.message);
                }
            }
        }

        async function saveFileContent(fileId, fileName) {
            const textarea = document.getElementById(`file-content-${fileId}`);
            if (!textarea) {
                alert('Textarea nenalezena');
                return;
            }

            const content = textarea.value;
            
            try {
                const response = await fetch(`/api/api/files/${fileId}/`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        content: content
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    console.error('API chyba:', error);
                    alert('Chyba p≈ôi ukl√°d√°n√≠: ' + JSON.stringify(error));
                    return;
                }

                const updatedFile = await response.json();
                
                // Aktualizuj soubor v pamƒõti
                if (windows[`window-file-${fileId}`]) {
                    windows[`window-file-${fileId}`].content = content;
                }

                // Aktualizuj seznam soubor≈Ø
                const fileIndex = files.findIndex(f => f.id === fileId);
                if (fileIndex !== -1) {
                    files[fileIndex].content = content;
                }
                
                // Zav≈ôi okno po √∫spƒõ≈°n√©m ulo≈æen√≠
                closeWindow(`window-file-${fileId}`);
                
            } catch (error) {
                console.error('Chyba:', error);
                alert('Chyba p≈ôi ukl√°d√°n√≠: ' + error.message);
            }
        }

        async function resetFileContent(fileId) {
            const textarea = document.getElementById(`file-content-${fileId}`);
            if (!textarea) {
                alert('Textarea nenalezena');
                return;
            }

            // Resetuj na p≈Øvodn√≠ obsah z pamƒõti
            if (windows[`window-file-${fileId}`]) {
                textarea.value = windows[`window-file-${fileId}`].content || '';
            }
        }

        function downloadFile(fileId, fileName, fileContent) {
            try {
                // Pokud je obsah data URL (pro bin√°rn√≠ soubory)
                if (fileContent.startsWith('data:')) {
                    const link = document.createElement('a');
                    link.href = fileContent;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    // Pro textov√© soubory, vytvo≈ôit blob
                    const blob = new Blob([fileContent], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }
            } catch (error) {
                console.error('Chyba p≈ôi stahov√°n√≠ souboru:', error);
                alert('Chyba p≈ôi stahov√°n√≠: ' + error.message);
            }
        }

        async function uploadFileFromDrop(droppedFile, targetFileType = null, posX = null, posY = null) {
            try {
                // Urƒçit typ souboru na z√°kladƒõ MIME type nebo p≈ô√≠pony
                let fileType = 'text';
                const fileName = droppedFile.name.toLowerCase();
                const mimeType = droppedFile.type;
                
                if (mimeType.startsWith('image/')) {
                    fileType = 'image';
                } else if (mimeType.startsWith('video/')) {
                    fileType = 'video';
                } else if (mimeType.startsWith('audio/')) {
                    fileType = 'audio';
                } else if (mimeType === 'application/pdf' || fileName.endsWith('.pdf')) {
                    fileType = 'document';
                } else if (mimeType === 'application/msword' || fileName.endsWith('.doc')) {
                    fileType = 'document';
                } else if (mimeType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' || fileName.endsWith('.docx')) {
                    fileType = 'document';
                } else if (mimeType === 'application/vnd.openxmlformats-officedocument.presentationml.presentation' || fileName.endsWith('.pptx')) {
                    fileType = 'document';
                } else if (mimeType === 'application/vnd.ms-powerpoint' || fileName.endsWith('.ppt')) {
                    fileType = 'document';
                } else if (mimeType.startsWith('application/vnd') || mimeType.startsWith('application/x-')) {
                    fileType = 'document';
                }

                // Pokud je zad√°n target file type, pou≈æ√≠t jej
                if (targetFileType) {
                    fileType = targetFileType;
                }

                // P≈ôeƒç√≠st obsah souboru
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const content = e.target.result; // Data URL pro obr√°zky/video/audio, text obsah pro ostatn√≠

                    // Ovƒõ≈ôit duplicitn√≠ jm√©no a z√≠skat unik√°tn√≠ jm√©no
                    let uniqueFileName = droppedFile.name;
                    if (checkDuplicateFileName(droppedFile.name, fileType, null)) {
                        uniqueFileName = getUniqueFileName(droppedFile.name, fileType, null);
                    }

                    // N√°hodn√° pozice, pokud nen√≠ zad√°na
                    const x = posX || Math.floor(Math.random() * 400) + 50;
                    const y = posY || Math.floor(Math.random() * 300) + 50;

                    // Poslat na server
                    const response = await fetch('/api/api/files/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({
                            name: uniqueFileName,
                            file_type: fileType,
                            content: content,
                            x_position: x,
                            y_position: y,
                            icon_color: getColorForFileType(fileType)
                        })
                    });

                    if (!response.ok) {
                        const error = await response.json();
                        console.error('API chyba:', error);
                        alert('Chyba p≈ôi nahr√°v√°n√≠ souboru: ' + JSON.stringify(error));
                        return;
                    }

                    const uploadedFile = await response.json();
                    
                    // P≈ôidat soubor do pamƒõti
                    files.push(uploadedFile);
                    
                    // Aktualizovat desktop
                    renderDesktop();
                    
                    // Pokud je otev≈ôeno okno image/video/audio/document typu, aktualizovat obsah
                    if (targetFileType && (targetFileType === 'image' || targetFileType === 'video' || targetFileType === 'audio' || targetFileType === 'document')) {
                        // Naj√≠t v≈°echna otev≈ôen√° okna dan√©ho typu
                        let updated = false;
                        Object.keys(windows).forEach(windowId => {
                            if (!updated) {
                                const windowEl = document.getElementById(windowId);
                                if (windowEl && windows[windowId].file_type === targetFileType) {
                                    // Aktualizovat obsah existuj√≠c√≠ho okna
                                    windows[windowId] = uploadedFile;
                                    
                                    // Zmƒõnit nadpis okna
                                    const titleEl = windowEl.querySelector('.window-title');
                                    if (titleEl) {
                                        titleEl.textContent = uploadedFile.name;
                                    }
                                    
                                    // Aktualizovat obsah
                                    let newContentHtml = '';
                                    if (targetFileType === 'image') {
                                        newContentHtml = `<div style="display: flex; flex-direction: column; flex: 1; overflow: auto; align-items: center; justify-content: center; padding: 20px;"><img src="${uploadedFile.content || ''}" style="max-width: 100%; max-height: 100%; object-fit: contain;" alt="${uploadedFile.name}" /></div>`;
                                    } else if (targetFileType === 'video') {
                                        newContentHtml = `<div style="display: flex; flex-direction: column; flex: 1; overflow: auto; padding: 10px;"><video style="width: 100%; height: 100%; object-fit: contain;" controls><source src="${uploadedFile.content || ''}" /></video></div>`;
                                    } else if (targetFileType === 'audio') {
                                        newContentHtml = `<div style="display: flex; flex-direction: column; flex: 1; overflow: auto; justify-content: center; align-items: center; padding: 20px;"><audio style="width: 90%;" controls><source src="${uploadedFile.content || ''}" /></audio></div>`;
                                    } else if (targetFileType === 'document') {
                                        const fileName = uploadedFile.name.toLowerCase();
                                        if (fileName.endsWith('.pdf')) {
                                            newContentHtml = `<div style="display: flex; flex-direction: column; flex: 1; overflow: auto;"><iframe src="${uploadedFile.content}" style="width: 100%; height: 100%; border: none;"></iframe></div>`;
                                        } else if (fileName.endsWith('.docx') || fileName.endsWith('.doc') || fileName.endsWith('.pptx') || fileName.endsWith('.ppt')) {
                                            newContentHtml = `<div style="display: flex; flex-direction: column; flex: 1; overflow: auto; padding: 20px; align-items: center; justify-content: center;"><p style="font-size: 16px; color: #666;">${uploadedFile.name}</p><p style="color: #999; margin-top: 10px;">Soubor ${uploadedFile.name.split('.').pop().toUpperCase()} se ned√° zobrazit v prohl√≠≈æeƒçi</p><button class="btn" onclick="downloadFile(${uploadedFile.id}, '${uploadedFile.name.replace(/'/g, "\\'")}', '${uploadedFile.content.replace(/'/g, "\\'")}')" style="margin-top: 20px;">St√°hnout soubor</button></div>`;
                                        } else {
                                            newContentHtml = `<div style="display: flex; flex-direction: column; flex: 1; overflow: auto; padding: 20px;"><p style="white-space: pre-wrap; word-wrap: break-word; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">${uploadedFile.content || 'Obsah dokumentu...'}</p></div>`;
                                        }
                                    }
                                    
                                    // Nahradit obsah okna (zachovat header)
                                    const header = windowEl.querySelector('.window-header');
                                    windowEl.innerHTML = header.outerHTML + newContentHtml;
                                    
                                    updated = true;
                                }
                            }
                        });
                    }
                };

                if (fileType === 'text') {
                    reader.readAsText(droppedFile);
                } else {
                    // Pro obr√°zky, video, audio, dokumenty - p≈ôeƒç√≠st jako data URL
                    reader.readAsDataURL(droppedFile);
                }

            } catch (error) {
                console.error('Chyba:', error);
                alert('Chyba: ' + error.message);
            }
        }

        async function confirmNewFile(e) {
            e.preventDefault();
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            
            let name = document.getElementById('newFileInput').value;
            if (name) {
                try {
                    // Ovƒõ≈ôit duplicitn√≠ jm√©no a z√≠skat unik√°tn√≠ jm√©no
                    if (checkDuplicateFileName(name, 'text', null)) {
                        name = getUniqueFileName(name, 'text', null);
                    }

                    // N√°hodn√° pozice, aby se ikony nep≈ôekr√Ωvaly
                    const x = Math.floor(Math.random() * 400) + 50;
                    const y = Math.floor(Math.random() * 300) + 50;
                    
                    const response = await fetch('/api/api/files/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({ 
                            name, 
                            file_type: 'text',
                            x_position: x,
                            y_position: y,
                            icon_color: getColorForFileType('text')
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        console.error('API chyba:', error);
                        alert('Chyba: ' + JSON.stringify(error));
                        submitButton.disabled = false;
                        return;
                    }
                    
                    const newFile = await response.json();
                    loadDesktopItems();
                    closeDialog('newFileDialog');
                    document.getElementById('newFileInput').value = '';
                    submitButton.disabled = false;
                    
                    // Otev≈ô√≠t nov√Ω soubor rovnou
                    setTimeout(() => {
                        openFile(newFile);
                    }, 100);
                } catch (error) {
                    console.error('Chyba p≈ôi vytv√°≈ôen√≠ souboru:', error);
                    alert('Chyba: ' + error.message);
                    submitButton.disabled = false;
                }
            } else {
                submitButton.disabled = false;
            }
        }

        async function confirmNewFolder(e) {
            e.preventDefault();
            let name = document.getElementById('newFolderInput').value;
            if (name) {
                try {
                    // Ovƒõ≈ôit duplicitn√≠ jm√©no a z√≠skat unik√°tn√≠ jm√©no
                    if (checkDuplicateFolderName(name)) {
                        name = getUniqueFolderName(name);
                    }

                    // N√°hodn√° pozice
                    const x = Math.floor(Math.random() * 400) + 50;
                    const y = Math.floor(Math.random() * 300) + 50;
                    
                    const response = await fetch('/api/api/folders/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({ 
                            name,
                            x_position: x,
                            y_position: y
                        })
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        console.error('API chyba:', error);
                        alert('Chyba: ' + JSON.stringify(error));
                        return;
                    }
                    
                    loadDesktopItems();
                    closeDialog('newFolderDialog');
                    document.getElementById('newFolderInput').value = '';
                } catch (error) {
                    console.error('Chyba p≈ôi vytv√°≈ôen√≠ slo≈æky:', error);
                    alert('Chyba: ' + error.message);
                }
            }
        }

        function closeDialog(dialogId) {
            document.getElementById(dialogId).classList.remove('active');
        }

        function minimizeWindow(windowId) {
            const window = document.getElementById(windowId);
            
            // Toggle minimalizaci - pokud je u≈æ minimalizovan√©, tak odminimalizovat
            if (window.classList.contains('minimized')) {
                window.classList.remove('minimized');
                const taskbarItem = document.getElementById('taskbar-' + windowId);
                if (taskbarItem) {
                    taskbarItem.classList.add('active');  // Gradient barva pro viditeln√© okno
                }
                
                // Zv√Ω≈°it z-index aby se okno dostalo do pop≈ôed√≠
                const maxZIndex = Math.max(...Array.from(document.querySelectorAll('.window')).map(el => {
                    const z = parseInt(el.style.zIndex) || parseInt(window.getComputedStyle(el).zIndex) || 0;
                    return isNaN(z) ? 0 : z;
                }));
                window.style.zIndex = (maxZIndex + 1).toString();
            } else {
                window.classList.add('minimized');
                const taskbarItem = document.getElementById('taskbar-' + windowId);
                if (taskbarItem) {
                    taskbarItem.classList.remove('active');  // Tmav√° barva pro minimalizovan√© okno
                }
                addToTaskbar(windowId);
            }
        }

        function addToTaskbar(windowId) {
            const window = document.getElementById(windowId);
            if (!window) return;
            
            const taskbarWindows = document.getElementById('taskbar-windows');
            
            // Zkontrolovat jestli je u≈æ v taskbaru
            if (document.getElementById('taskbar-' + windowId)) {
                return;
            }
            
            // Z√≠skat n√°zev z window title
            const titleEl = window.querySelector('.window-title');
            const title = titleEl ? titleEl.textContent : 'Okno';
            
            // Vytvo≈ôit taskbar item
            const taskbarItem = document.createElement('div');
            taskbarItem.className = 'taskbar-item';
            taskbarItem.id = 'taskbar-' + windowId;
            taskbarItem.textContent = title;
            taskbarItem.onclick = () => {
                const w = document.getElementById(windowId);
                if (w.classList.contains('minimized')) {
                    // Odminimalizovat a p≈ôesunout do pop≈ôed√≠
                    w.classList.remove('minimized');
                    taskbarItem.classList.add('active');  // P≈ôidat active t≈ô√≠da kdy≈æ je viditeln√©
                    
                    // Zv√Ω≈°it z-index aby se okno dostalo do pop≈ôed√≠
                    const maxZIndex = Math.max(...Array.from(document.querySelectorAll('.window')).map(el => {
                        const z = parseInt(el.style.zIndex) || parseInt(window.getComputedStyle(el).zIndex) || 0;
                        return isNaN(z) ? 0 : z;
                    }));
                    w.style.zIndex = (maxZIndex + 1).toString();
                } else {
                    // Minimalizovat
                    w.classList.add('minimized');
                    taskbarItem.classList.remove('active');  // Odebrat active t≈ô√≠da kdy≈æ je minimalizovan√©
                }
            };
            
            // Kdy≈æ je okno otev≈ôeno, oznaƒçit taskbar item
            taskbarItem.classList.add('active');
            taskbarWindows.appendChild(taskbarItem);
        }

        function removeFromTaskbar(windowId) {
            const taskbarItem = document.getElementById('taskbar-' + windowId);
            if (taskbarItem) {
                taskbarItem.remove();
            }
        }

        function maximizeWindow(windowId) {
            const window = document.getElementById(windowId);
            if (window.style.width === '100%') {
                // Restore to normal size
                window.style.width = '600px';
                window.style.height = '400px';
                window.style.left = '100px';
                window.style.top = '100px';
            } else {
                // Maximize but leave space for taskbar
                const taskbarHeight = 120; // taskbar + padding
                window.style.width = '100%';
                window.style.height = `calc(100% - ${taskbarHeight}px)`;
                window.style.left = '0';
                window.style.top = '0';
            }
        }

        function closeWindow(windowId) {
            // Check if this is a text file with unsaved changes
            if (windowId.startsWith('window-file-')) {
                const fileId = windowId.replace('window-file-', '');
                const file = files.find(f => f.id == fileId);
                
                if (file && file.file_type === 'text') {
                    const textarea = document.getElementById(`file-content-${fileId}`);
                    if (textarea) {
                        // Just close without asking - auto-save or discard
                    }
                }
            }
            
            removeFromTaskbar(windowId);
            document.getElementById(windowId).remove();
            delete windows[windowId];
        }

        function logout() {
            showConfirm('Odhl√°≈°en√≠', 'Opravdu se chcete odhl√°sit?', (confirmed) => {
                if (confirmed) {
                    window.location.href = '/logout/';
                }
            });
        }

        // Mailing System Functions
        let mailAttachments = [];
        let currentMessageId = null;  // Sleduje jakou zpr√°vu si pr√°vƒõ ƒçte

        function openMailingWindow() {
            document.getElementById('mailingDialog').classList.add('active');
            
            // Reset form
            document.getElementById('mailRecipients').value = '';
            document.getElementById('mailSubject').value = '';
            document.getElementById('mailBody').value = '';
            mailAttachments = [];
            document.getElementById('mailAttachmentList').innerHTML = '';
        }

        function updateMailAttachmentList() {
            const list = document.getElementById('mailAttachmentList');
            list.innerHTML = '';
            
            mailAttachments.forEach((attachment, index) => {
                const tag = document.createElement('div');
                tag.style.cssText = 'background: #667eea; color: white; padding: 6px 12px; border-radius: 4px; font-size: 12px; display: flex; align-items: center; gap: 6px;';
                tag.innerHTML = `
                    ${attachment.name}
                    <button type="button" style="background: none; border: none; color: white; cursor: pointer; font-size: 14px; padding: 0;" onclick="removeMailAttachment(${index})">‚úï</button>
                `;
                list.appendChild(tag);
            });
        }

        function removeMailAttachment(index) {
            mailAttachments.splice(index, 1);
            updateMailAttachmentList();
        }

        async function sendMail(event) {
            event.preventDefault();
            
            const recipients = document.getElementById('mailRecipients').value
                .split(',')
                .map(r => r.trim())
                .filter(r => r);
            
            if (recipients.length === 0) {
                showMessageDialog('Chyba', 'Zadejte alespo≈à jednoho p≈ô√≠jemce');
                return;
            }
            
            const subject = document.getElementById('mailSubject').value.trim();
            const body = document.getElementById('mailBody').value.trim();
            
            if (!subject || !body) {
                showMessageDialog('Chyba', 'Vypl≈àte p≈ôedmƒõt a zpr√°vu');
                return;
            }
            
            // Prepare attachment data
            const attachmentData = mailAttachments.map(att => ({
                id: att.id,
                type: att.type,
                name: att.name
            }));
            
            // Store data for confirmation
            pendingMailData = {
                recipients: recipients,
                subject: subject,
                body: body,
                attachmentData: attachmentData
            };
            
            // Show confirmation dialog
            showSendMailConfirm(recipients.length, attachmentData.length);
        }

        async function openReceivedMessagesWindow() {
            document.getElementById('receivedMessagesDialog').classList.add('active');
            await loadReceivedMessages();
        }

        async function loadReceivedMessages() {
            try {
                const response = await fetch('/api/api/messages/inbox/', {
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                });
                
                if (!response.ok) {
                    document.getElementById('messagesList').innerHTML = '<p style="color: #e74c3c;">Chyba p≈ôi naƒç√≠t√°n√≠ zpr√°v</p>';
                    return;
                }
                
                const messages = await response.json();
                console.log('Loaded messages:', messages);  // Debug
                
                if (messages.length === 0) {
                    document.getElementById('messagesList').innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Zat√≠m jste neobdr≈æeli ≈æ√°dn√© zpr√°vy</p>';
                    return;
                }
                
                let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';
                
                messages.forEach(message => {
                    console.log('Message attachments:', message.attachments);  // Debug
                    const date = new Date(message.created_at);
                    const formattedDate = date.toLocaleString('cs-CZ');
                    const unreadClass = message.is_read ? '' : ' style="background: #f0f0f0; border-left: 4px solid #667eea;"';
                    
                    let attachmentsHtml = '';
                    if (message.attachments && message.attachments.length > 0) {
                        attachmentsHtml = '<div style="font-size: 11px; color: #666; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">';
                        message.attachments.forEach(att => {
                            console.log('Attachment:', att);  // Debug
                            const iconTypes = {
                                'text': 'üìÑ',
                                'image': 'üñºÔ∏è',
                                'document': 'üìã',
                                'video': 'üé¨',
                                'audio': 'üéµ',
                                'archive': 'üì¶',
                                'other': 'üìÅ'
                            };
                            let icon = 'üìÅ';
                            let attName = '';
                            if (att.file_name) {
                                attName = att.file_name;
                                icon = iconTypes[att.file_type] || 'üìÑ';
                            } else if (att.folder_name) {
                                attName = att.folder_name;
                                icon = 'üìÅ';
                            }
                            attachmentsHtml += `<div style="margin: 2px 0;">${icon} ${attName}</div>`;
                        });
                        attachmentsHtml += '</div>';
                    }
                    
                    html += `
                        <div${unreadClass} style="padding: 12px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f9f9f9'" onmouseout="this.style.background='${message.is_read ? 'white' : '#f0f0f0'}'" onclick="viewMessage(${message.id})">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                                <div style="font-weight: 600; color: #333;">Od: ${message.sender_username}</div>
                                <div style="font-size: 12px; color: #999;">${formattedDate}</div>
                            </div>
                            <div style="font-weight: 500; margin-bottom: 5px; color: #667eea;">P≈ôedmƒõt: ${message.subject}</div>
                            <div style="font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${message.body.substring(0, 100)}</div>
                            ${attachmentsHtml}
                        </div>
                    `;
                });
                
                html += '</div>';
                document.getElementById('messagesList').innerHTML = html;
                
            } catch (error) {
                console.error('Chyba:', error);
                document.getElementById('messagesList').innerHTML = '<p style="color: #e74c3c;">Chyba p≈ôi naƒç√≠t√°n√≠ zpr√°v: ' + error.message + '</p>';
            }
        }

        async function viewMessage(messageId) {
            try {
                const response = await fetch(`/api/api/messages/${messageId}/`, {
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                });
                
                if (!response.ok) {
                    alert('Chyba p≈ôi naƒç√≠t√°n√≠ zpr√°vy');
                    return;
                }
                
                const message = await response.json();
                
                // Mark as read if not already
                if (!message.is_read) {
                    await fetch(`/api/api/messages/${messageId}/mark_as_read/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken
                        }
                    });
                    updateUnreadBadge();
                }
                
                // Create and display message details window
                createMessageDetailsWindow(message);
                
            } catch (error) {
                console.error('Chyba:', error);
                alert('Chyba p≈ôi otev√≠r√°n√≠ zpr√°vy');
            }
        }

        function createMessageDetailsWindow(message) {
            currentMessageId = message.id;  // Nastavit aktu√°ln√≠ zpr√°vu
            const windowId = 'window-message-' + message.id;
            const existingWindow = document.getElementById(windowId);
            
            if (existingWindow) {
                existingWindow.remove();
            }
            
            const window = document.createElement('div');
            window.className = 'window';
            window.id = windowId;
            
            // Get smart position for window
            const pos = getNextWindowPosition();
            window.style.left = pos.x + 'px';
            window.style.top = pos.y + 'px';
            
            window.style.width = '700px';
            window.style.height = '500px';
            window.style.zIndex = '500';

            const date = new Date(message.created_at);
            const formattedDate = date.toLocaleString('cs-CZ');
            
            let attachmentsHtml = '';
            if (message.attachments && message.attachments.length > 0) {
                attachmentsHtml = '<div style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px;"><strong>P≈ô√≠lohy:</strong><div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;">';
                message.attachments.forEach((att, idx) => {
                    const iconTypes = {
                        'text': 'üìÑ',
                        'image': 'üñºÔ∏è',
                        'document': 'üìã',
                        'video': 'üé¨',
                        'audio': 'üéµ',
                        'archive': 'üì¶',
                        'other': 'üìÅ'
                    };
                    
                    let attName = '';
                    let icon = 'üìÅ';
                    let attId = '';
                    let attType = '';
                    
                    if (att.file_name) {
                        attName = att.file_name;
                        icon = iconTypes[att.file_type] || 'üìÑ';
                        attId = att.file;
                        attType = 'file';
                    } else if (att.folder_name) {
                        attName = att.folder_name;
                        icon = 'üìÅ';
                        attId = att.folder;
                        attType = 'folder';
                    }
                    
                    attachmentsHtml += `
                        <div 
                            class="attachment-item-msg"
                            draggable="true"
                            data-item-id="${attId}"
                            data-item-type="${attType}"
                            data-item-name="${attName}"
                            style="background: #667eea; color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; cursor: grab; user-select: none;"
                            ondragstart="startAttachmentDrag(event)"
                            ondragend="endAttachmentDrag(event)"
                        >
                            ${icon} ${attName}
                        </div>
                    `;
                });
                attachmentsHtml += '</div></div>';
            }

            window.innerHTML = `
                <div class="window-header">
                    <div class="window-title">‚úâÔ∏è Flux od ${message.sender_username}</div>
                    <div class="window-controls">
                        <button class="window-btn" onclick="minimizeWindow('${windowId}')">‚àí</button>
                        <button class="window-btn" onclick="maximizeWindow('${windowId}')">‚ñ°</button>
                        <button class="window-btn" onclick="closeWindow('${windowId}')">‚úï</button>
                    </div>
                </div>
                <div class="window-content" style="display: flex; flex-direction: column; overflow-y: auto; padding: 15px;">
                    <div style="display: grid; grid-template-columns: 100px 1fr; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #ddd; padding-bottom: 10px;">
                        <strong>Od:</strong><div>${message.sender_username}</div>
                        <strong>P≈ôedmƒõt:</strong><div>${message.subject}</div>
                        <strong>Datum:</strong><div>${formattedDate}</div>
                    </div>
                    <div style="flex: 1; white-space: pre-wrap; word-wrap: break-word; font-family: monospace; font-size: 13px; line-height: 1.6; color: #333; margin-bottom: 15px;">${message.body}</div>
                    ${attachmentsHtml}
                </div>
            `;

            document.body.appendChild(window);
            makeWindowDraggable(window);
            makeWindowResizable(window);
            addToTaskbar(windowId);
            windows[windowId] = { title: `Flux od ${message.sender_username}` };
        }

        async function updateUnreadBadge() {
            try {
                const response = await fetch('/api/api/messages/inbox/', {
                    headers: {
                        'X-CSRFToken': csrftoken
                    }
                });
                
                if (response.ok) {
                    const messages = await response.json();
                    const unreadCount = messages.filter(m => !m.is_read).length;
                    const badge = document.getElementById('unreadBadge');
                    
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Chyba p≈ôi aktualizaci ozn√°men√≠:', error);
            }
        }

        // Initialize unread badge on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadDesktopItems();
            setupEventListeners();
            updateUnreadBadge();
            // Refresh badge every 30 seconds
            setInterval(updateUnreadBadge, 30000);
            
            // Initialize desktop pan and zoom
            initializeDesktopPanZoom();
        });

        // Desktop Pan and Zoom System
        let desktopOffsetX = 0;
        let desktopOffsetY = 0;
        let desktopZoom = 1;
        let isDraggingDesktop = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let dragStartOffsetX = 0;
        let dragStartOffsetY = 0;
        const minZoom = 0.3;
        const maxZoom = 3;
        const DESKTOP_GRID_SIZE = 5; // 5x5 desktop≈Ø

        function initializeDesktopPanZoom() {
            const desktop = document.getElementById('desktop');

            // Ta≈æen√≠ my≈°√≠
            document.addEventListener('mousedown', (e) => {
                // Ignoruj pokud je klik na ikonu nebo okno
                if (e.target.closest('.desktop-icon') || e.target.closest('.window')) {
                    return;
                }
                
                if (e.button !== 0) return; // Pouze lev√© tlaƒç√≠tko
                
                isDraggingDesktop = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                dragStartOffsetX = desktopOffsetX;
                dragStartOffsetY = desktopOffsetY;
                
                desktop.classList.add('dragging');
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDraggingDesktop) return;

                // Delta bez zoom - pohyb v screen koordin√°t√°ch
                const deltaX = e.clientX - dragStartX;
                const deltaY = e.clientY - dragStartY;

                let newOffsetX = dragStartOffsetX + deltaX;
                let newOffsetY = dragStartOffsetY + deltaY;

                // Aplikuj hranice - obd√©ln√≠k 5x5 desktop≈Ø
                // Maxim√°ln√≠ vzd√°lenost kterou se m≈Ø≈æe≈° pohnout: 4 viewporty √ó zoom
                // Zoom ovliv≈àuje bari√©ry - kdy≈æ je zoom men≈°√≠, vid√≠≈° v√≠c obsahu
                const maxPan = (DESKTOP_GRID_SIZE - 1) * window.innerWidth * desktopZoom;
                const maxPanY = (DESKTOP_GRID_SIZE - 1) * window.innerHeight * desktopZoom;

                // Omez offset mezi -maxPan a 0
                desktopOffsetX = Math.max(-maxPan, Math.min(0, newOffsetX));
                desktopOffsetY = Math.max(-maxPanY, Math.min(0, newOffsetY));

                updateDesktopTransform();
            });

            document.addEventListener('mouseup', () => {
                if (isDraggingDesktop) {
                    isDraggingDesktop = false;
                    desktop.classList.remove('dragging');
                }
            });

            // Zoom s koleƒçkem my≈°i (bez Ctrl) s animac√≠
            document.addEventListener('wheel', (e) => {
                // Pokud je kurzor nad desktopem
                if (!e.target.closest('#desktop')) {
                    return;
                }
                
                e.preventDefault();
                
                const zoomSpeed = 0.1;
                const oldZoom = desktopZoom;
                
                // Smƒõr scrollu - nahoru = p≈ôibl√≠≈æit, dol≈Ø = odd√°lit
                if (e.deltaY < 0) {
                    desktopZoom = Math.min(desktopZoom + zoomSpeed, maxZoom);
                } else {
                    desktopZoom = Math.max(desktopZoom - zoomSpeed, minZoom);
                }
                
                // Pozice kurzoru na obrazovce
                const cursorScreenX = e.clientX;
                const cursorScreenY = e.clientY;
                
                // Pozice kurzoru v desktopov√Ωch sou≈ôadnic√≠ch (p≈ôed zoomem)
                const cursorDesktopX = (cursorScreenX - desktopOffsetX) / oldZoom;
                const cursorDesktopY = (cursorScreenY - desktopOffsetY) / oldZoom;
                
                // Nov√° pozice offsetu aby z≈Østal kurzor na stejn√©m m√≠stƒõ
                let newOffsetX = cursorScreenX - cursorDesktopX * desktopZoom;
                let newOffsetY = cursorScreenY - cursorDesktopY * desktopZoom;

                // Aplikuj hranice - obd√©ln√≠k 5x5 desktop≈Ø
                // Bari√©ry berou v √∫vahu nov√Ω zoom - kdy≈æ je zoom men≈°√≠, vid√≠≈° v√≠c
                const maxPan = (DESKTOP_GRID_SIZE - 1) * window.innerWidth * desktopZoom;
                const maxPanY = (DESKTOP_GRID_SIZE - 1) * window.innerHeight * desktopZoom;

                // Omez offset mezi -maxPan a 0
                newOffsetX = Math.max(-maxPan, Math.min(0, newOffsetX));
                newOffsetY = Math.max(-maxPanY, Math.min(0, newOffsetY));
                
                // Pokud se offset zmƒõnil kv≈Øli bari√©r√°m, p≈ôilep√≠me desktop na bari√©ru
                // Kurzor se bude pohybovat, ale offset z≈Østane v mez√≠ch
                desktopOffsetX = newOffsetX;
                desktopOffsetY = newOffsetY;
                
                updateDesktopTransform();
            }, { passive: false });
        }

        function updateDesktopTransform() {
            const desktop = document.getElementById('desktop');
            desktop.style.transform = `translate(${desktopOffsetX}px, ${desktopOffsetY}px) scale(${desktopZoom})`;
        }

        // Attachment Selector Functions
        async function openAttachmentSelector() {
            document.getElementById('attachmentSelectorDialog').classList.add('active');
            
            const content = document.getElementById('attachmentSelectorContent');
            content.innerHTML = '<p style="text-align: center; color: #999;">Naƒç√≠t√°n√≠...</p>';
            
            try {
                // Fetch user's desktop files and folders
                const filesResponse = await fetch('/api/api/files/all_files/', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    }
                });
                const filesData = await filesResponse.json();
                
                const foldersResponse = await fetch('/api/api/folders/root_folders/', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    }
                });
                const foldersData = await foldersResponse.json();
                
                // Build checkbox list
                let html = '';
                
                if (filesData.length > 0 || foldersData.length > 0) {
                    // Desktop files (bez slo≈æky)
                    const rootFiles = filesData.filter(f => !f.folder);
                    if (rootFiles.length > 0) {
                        html += '<h4 style="margin-bottom: 10px; color: #333;">üìÑ Soubory na plo≈°e:</h4>';
                        rootFiles.forEach(file => {
                            const isChecked = mailAttachments.some(a => a.id === file.id && a.type === 'file') ? 'checked' : '';
                            html += `
                                <div style="margin-bottom: 8px; margin-left: 10px;">
                                    <input type="checkbox" id="file_${file.id}" data-type="file" data-id="${file.id}" data-name="${file.name}" ${isChecked} class="attachment-checkbox">
                                    <label for="file_${file.id}" style="margin-left: 5px; cursor: pointer; color: #555;">${file.name}</label>
                                </div>
                            `;
                        });
                    }
                    
                    // Desktop folders
                    if (foldersData.length > 0) {
                        html += '<h4 style="margin-top: 15px; margin-bottom: 10px; color: #333;">üìÅ Slo≈æky na plo≈°e:</h4>';
                        foldersData.forEach(folder => {
                            const isChecked = mailAttachments.some(a => a.id === folder.id && a.type === 'folder') ? 'checked' : '';
                            
                            // Slo≈æka
                            html += `
                                <div style="margin-bottom: 8px;">
                                    <input type="checkbox" id="folder_${folder.id}" data-type="folder" data-id="${folder.id}" data-name="${folder.name}" ${isChecked} class="attachment-checkbox">
                                    <label for="folder_${folder.id}" style="margin-left: 5px; cursor: pointer; color: #555; font-weight: bold;">üìÅ ${folder.name}</label>
                                </div>
                            `;
                            
                            // Soubory v t√©to slo≈æce (indentovan√©)
                            const folderFiles = filesData.filter(f => f.folder === folder.id);
                            if (folderFiles.length > 0) {
                                html += '<div style="margin-left: 30px; margin-bottom: 8px;">';
                                folderFiles.forEach(file => {
                                    const isFileChecked = mailAttachments.some(a => a.id === file.id && a.type === 'file') ? 'checked' : '';
                                    html += `
                                        <div style="margin-bottom: 6px;">
                                            <input type="checkbox" id="file_${file.id}" data-type="file" data-id="${file.id}" data-name="${file.name}" ${isFileChecked} class="attachment-checkbox">
                                            <label for="file_${file.id}" style="margin-left: 5px; cursor: pointer; color: #666; font-size: 13px;">üìÑ ${file.name}</label>
                                        </div>
                                    `;
                                });
                                html += '</div>';
                            }
                        });
                    }
                } else {
                    html = '<p style="color: #999; text-align: center;">≈Ω√°dn√© soubory nebo slo≈æky na plo≈°e</p>';
                }
                
                content.innerHTML = html;
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ p≈ô√≠loh:', error);
                content.innerHTML = '<p style="color: red; text-align: center;">Chyba p≈ôi naƒç√≠t√°n√≠ p≈ô√≠loh</p>';
            }
        }

        function confirmAttachmentSelection() {
            const checkboxes = document.querySelectorAll('.attachment-checkbox:checked');
            mailAttachments = [];
            
            checkboxes.forEach(checkbox => {
                mailAttachments.push({
                    id: parseInt(checkbox.dataset.id),
                    type: checkbox.dataset.type,
                    name: checkbox.dataset.name
                });
            });
            
            updateMailAttachmentList();
            closeDialog('attachmentSelectorDialog');
        }

    </script>
</body>
</html>
